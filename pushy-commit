#!/bin/dash
# if [ "$#" -lt 2 ]; then
# 	echo "Usage: ./pushy-commit [-a] -m message"
# 	exit 1
# fi

usage () { echo "Usage: ./pushy-commit [-a] -m message"; exit 1; }

if [ "$#" -lt 2 ]; then
	usage
fi

a=0
m=""
while getopts "am:" o;
do
	case "${o}" in
		a)
			a=1
			;;
		m)
			m=${OPTARG}
			;;
		*)
			usage
			;;
	esac
done

[ ! "$m" ] && usage

cd ".pushy" || exit
[ ! -d ".commits" ] && mkdir -p ".commits"
count=$(< log.txt wc -l)
mkdir -p ".commits/$count"
cd ".index"|| exit 1;
pattern='^[^-]*$'
if echo "$m" | grep -Eq "$pattern";
then
	changes=0

	if [ "$a" -ne 0 ]:
	then
		for file in *
		do
			#Get contents from current directory added to index
			cp "../../$file" "$file"
		done
	fi

	for file in *
	do
		#First check the if file exists in repo
		if [ ! -f "../$file" ];
		then
			changes=$((changes + 1))
		#Next check different to existing file
		elif ! cmp -s "$file" "../$file";
		then
			changes=$((changes + 1))
		fi
	done


	#If there has been a deletion from the index, remove the file from the repo
	cd "../" || exit 1
	for file in *
	do
		if [ ! -f ".index/$file" ] && [ ! "$file" = "log.txt" ]
		then
			rm "$file"
			changes=$((changes + 1))
		fi
	done

	cd ".index" || exit 1
	if [ "$changes" -eq 0 ];
	then
		echo "nothing to commit"
		exit 1
	else
	for file in *
	do
		if [ ! "$file" = "*" ];
		then
			cp "$file" "../$file"
			cp "$file" "../.commits/$count/$file"
		fi
	done
	fi
fi
cd ../ || exit 1


echo "Committed as commit $count"
echo "$count $2" >> log.txt
